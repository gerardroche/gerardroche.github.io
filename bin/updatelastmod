#!/bin/sh

set -e
unset CDPATH
unset IFS

echo "Updating lastmode ..."
git ls-tree -r --name-only HEAD _posts/*.md | while read post; do
    test -f "$post" || continue
    full_date="$(git log -1 --format="%aI" -- $post)"
    # strip seconds from date to try to avoid race conditions
    date="$(echo "$full_date" | head -c 16):00$(echo "$full_date" | tail -c 7)"

    sed -i '/^last_modified_at\:.*/d' "$post"
    sed -i ':a;N;$!ba;s/^\(---\n.*\)\n---/\1\nlast_modified_at\: '"$date"'\n---/g' "$post"
done

echo "Updating lastmode done"
