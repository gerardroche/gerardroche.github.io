#!/bin/sh

set -e
unset CDPATH
unset IFS

update_last_modified_at() {
    post="$1"
    full_date="$(git log -1 --format="%aI" -- $post)"
    # strip seconds from date to try to avoid race conditions
    date="$(echo "$full_date" | head -c 16):00$(echo "$full_date" | tail -c 7)"
    sed -i 's/^\(last_modified_at\:\).*$/\1 '"$date"'/g' "$post"
}

echo "Updating lastmode ..."

git ls-tree -r --name-only HEAD _posts/*.md | while read post; do
    test -f "$post" || continue
    update_last_modified_at "$post"
done

git ls-tree -r --name-only HEAD _archive-tags/*.html | while read post; do
    test -f "$post" || continue
    update_last_modified_at "$post"
done

git add _archive-tags/
git add _posts/

echo "done"
